<div class="create-appointment-container">
  <mat-card class="appointment-card">
    <mat-card-header>
      <mat-card-title>
        <h1>üìÖ Prendre un rendez-vous</h1>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()">

        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Choisir un m√©decin</mat-label>
          <mat-select formControlName="doctorId" (selectionChange)="onDoctorChange($event)">
            <mat-option *ngFor="let doctor of doctors" [value]="doctor.userId">
              Dr. {{ doctor.user?.firstName }} {{ doctor.user?.lastName }}
              - {{ getSpecialtyLabel(doctor.specialty) }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="appointmentForm.get('doctorId')?.hasError('required')">
            Veuillez choisir un m√©decin
          </mat-error>
        </mat-form-field>

        <div class="doctor-info" *ngIf="selectedDoctor">
          <mat-icon>info</mat-icon>
          <div>
            <p><strong>Disponibilit√© :</strong>
              {{ selectedDoctor.availableFrom }} - {{ selectedDoctor.availableTo }}
            </p>
            <p *ngIf="selectedDoctor.consultationFee">
              <strong>Tarif :</strong> {{ selectedDoctor.consultationFee }}‚Ç¨
            </p>
          </div>
        </div>

        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Date du rendez-vous</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="appointmentDate"
                 [min]="minDate" placeholder="Choisir une date">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="appointmentForm.get('appointmentDate')?.hasError('required')">
            La date est requise
          </mat-error>
        </mat-form-field>

        <div class="time-fields">
          <mat-form-field appearance="outline">
            <mat-label>Heure</mat-label>
            <mat-select formControlName="hour">
              <mat-option *ngFor="let hour of hours" [value]="hour.toString().padStart(2, '0')">
                {{ hour | number:'2.0-0' }}h
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Minutes</mat-label>
            <mat-select formControlName="minute">
              <mat-option value="00">00</mat-option>
              <mat-option value="15">15</mat-option>
              <mat-option value="30">30</mat-option>
              <mat-option value="45">45</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="availability-feedback" [ngClass]="slotStatus" *ngIf="slotStatus !== 'idle'">
          <mat-icon>{{ getSlotStatusIcon() }}</mat-icon>
          <span>{{ slotMessage }}</span>
          <mat-spinner *ngIf="slotStatus === 'checking'" diameter="18"></mat-spinner>
        </div>

        <div class="conflicts-panel" *ngIf="conflictingAppointments.length > 0">
          <h3>
            <mat-icon color="warn">report_problem</mat-icon>
            Cr√©neaux en conflit
          </h3>
          <mat-list dense>
            <mat-list-item *ngFor="let appointment of conflictingAppointments; trackBy: trackByAppointment">
              <mat-icon matListIcon color="warn">event_busy</mat-icon>
              <div matLine>
                {{ appointment.appointmentDate | date:'dd/MM/yyyy HH:mm' }}
              </div>
              <div matLine class="secondary">
                {{ appointment.reason }} ‚Ä¢ {{ appointment.duration }} min
              </div>
            </mat-list-item>
          </mat-list>
        </div>

        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Dur√©e (minutes)</mat-label>
          <mat-select formControlName="duration">
            <mat-option [value]="15">15 minutes</mat-option>
            <mat-option [value]="30">30 minutes</mat-option>
            <mat-option [value]="45">45 minutes</mat-option>
            <mat-option [value]="60">1 heure</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Motif de consultation</mat-label>
          <textarea matInput formControlName="reason" rows="3"
                    placeholder="D√©crivez bri√®vement le motif de votre consultation"></textarea>
          <mat-error *ngIf="appointmentForm.get('reason')?.hasError('required')">
            Le motif est requis
          </mat-error>
          <mat-error *ngIf="appointmentForm.get('reason')?.hasError('minlength')">
            Minimum 10 caract√®res
          </mat-error>
        </mat-form-field>

        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Notes additionnelles (optionnel)</mat-label>
          <textarea matInput formControlName="notes" rows="2"
                    placeholder="Informations compl√©mentaires..."></textarea>
        </mat-form-field>

        <div class="actions">
          <button mat-raised-button type="button" routerLink="/doctors">
            Annuler
          </button>
          <button mat-raised-button color="primary" type="submit"
                  [disabled]="submitDisabled">
            <span *ngIf="!loading">Confirmer le rendez-vous</span>
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
