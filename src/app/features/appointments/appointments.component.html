<div class="appointments-container">
  <div class="header">
    <div>
      <h1>üìÖ Mes Rendez-vous</h1>
      <p class="subtitle">Retrouvez vos consultations pass√©es et √† venir</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button color="primary" type="button"
              (click)="exportCsv()"
              [disabled]="dataSource.data.length === 0">
        <mat-icon>file_download</mat-icon>
        Export CSV
      </button>
      <button mat-raised-button color="primary" routerLink="/appointments/create">
        <mat-icon>add</mat-icon>
        Nouveau rendez-vous
      </button>
    </div>
  </div>

  <mat-card class="filters-card">
    <form [formGroup]="filterForm">
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Statut</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let option of statusOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Recherche</mat-label>
          <input matInput placeholder="Patient, m√©decin, motif..." formControlName="search">
          <button mat-icon-button matSuffix type="button"
                  *ngIf="filterForm.get('search')?.value"
                  (click)="filterForm.get('search')?.reset('')">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" class="date-range">
          <mat-label>P√©riode</mat-label>
          <mat-date-range-input [rangePicker]="picker" formGroupName="dateRange">
            <input matStartDate placeholder="D√©but">
            <input matEndDate placeholder="Fin">
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>

        <div class="filter-actions">
          <button mat-button type="button" (click)="clearFilters()" [disabled]="!hasActiveFilters()">
            R√©initialiser
          </button>
          <button mat-stroked-button color="primary" type="button" (click)="applyFilters()">
            Appliquer
          </button>
        </div>
      </div>
    </form>
  </mat-card>

  <div class="summary-bar" *ngIf="!loading">
    <span>{{ dataSource.data.length }} rendez-vous affich√©s</span>
    <button mat-icon-button type="button" (click)="refresh()" matTooltip="Recharger">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <div class="table-wrapper" *ngIf="!loading && dataSource.data.length > 0">
    <table mat-table [dataSource]="dataSource" matSort matSortActive="appointmentDate" matSortDirection="desc" class="mat-elevation-z2">
      <ng-container matColumnDef="appointmentDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
        <td mat-cell *matCellDef="let appointment">
          {{ appointment.appointmentDate | date:'dd/MM/yyyy HH:mm' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="doctor">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="doctor">M√©decin</th>
        <td mat-cell *matCellDef="let appointment">
          Dr. {{ appointment.doctor?.firstName }} {{ appointment.doctor?.lastName }}
        </td>
      </ng-container>

      <ng-container matColumnDef="patient">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="patient">Patient</th>
        <td mat-cell *matCellDef="let appointment">
          {{ appointment.patient?.firstName }} {{ appointment.patient?.lastName }}
        </td>
      </ng-container>

      <ng-container matColumnDef="reason">
        <th mat-header-cell *matHeaderCellDef>Motif</th>
        <td mat-cell *matCellDef="let appointment" [matTooltip]="appointment.reason">
          {{ appointment.reason }}
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Statut</th>
        <td mat-cell *matCellDef="let appointment">
          <mat-chip [color]="getStatusColor(appointment.status)" selected>
            {{ getStatusLabel(appointment.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="duration">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="duration">Dur√©e</th>
        <td mat-cell *matCellDef="let appointment">
          {{ appointment.duration || 30 }} min
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let appointment">
          <button mat-icon-button color="primary"
                  matTooltip="Ouvrir la consultation en ligne"
                  (click)="startConsultation(appointment)"
                  [disabled]="startingConsultations.has(appointment.id)"
                  *ngIf="canStartConsultation(appointment)">
            <mat-icon>video_call</mat-icon>
          </button>
          <button mat-icon-button color="warn"
                  matTooltip="Annuler ce rendez-vous"
                  (click)="cancelAppointment(appointment.id)"
                  *ngIf="appointment.status !== AppointmentStatus.CANCELLED">
            <mat-icon>cancel</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByAppointment"></tr>
    </table>

    <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20, 50]" showFirstLastButtons></mat-paginator>
  </div>

  <div class="loading-state" *ngIf="loading">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Chargement des rendez-vous...</p>
  </div>

  <div class="no-data" *ngIf="!loading && dataSource.data.length === 0">
    <mat-icon>event_busy</mat-icon>
    <h3>Aucun rendez-vous trouv√©</h3>
    <p>Essayez d'√©largir votre recherche ou changez la p√©riode s√©lectionn√©e.</p>
    <button mat-raised-button color="primary" routerLink="/appointments/create">
      Planifier un rendez-vous
    </button>
  </div>
</div>
